@page "/libros/catalogo"
@using MudBlazor
@using SistemaBiblioteca.Modelos
@using SistemaBiblioteca.Data
@using Microsoft.EntityFrameworkCore
@inherits LayoutComponentBase
@inject BibliotecaContext Contexto
@inject IDialogService DialogService

<style>
    /* --- ESTILOS VISUALES (NETFLIX / AMAZON STYLE) --- */

    /* 1. Fondo sutil para toda la página */
    .catalogo-container {
        padding-bottom: 4rem;
    }

    /* 2. Barra de Búsqueda Flotante y Moderna */
    .search-bar-glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        padding: 0.8rem 1.5rem;
        border-radius: 50px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
        max-width: 800px;
        margin: 0 auto 3rem auto; /* Centrado */
    }

        .search-bar-glass:focus-within {
            box-shadow: 0 12px 40px rgba(40, 115, 180, 0.2); /* Brillo azul al escribir */
            transform: scale(1.01);
            border-color: var(--azul-oscuro);
        }

    /* 3. Tarjeta del Libro */
    .libro-card {
        border-radius: 12px;
        overflow: hidden;
        background: white;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        cursor: pointer;
        position: relative;
        height: 100%;
        border: 1px solid #f0f0f0;
    }

        /* Efecto Hover (Levantar tarjeta) */
        .libro-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            z-index: 10;
        }

    /* 4. Etiquetas de Stock (Badges) */
    .badge-stock {
        position: absolute;
        top: 12px;
        right: 12px;
        padding: 4px 12px;
        border-radius: 20px;
        color: white;
        font-weight: 700;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        z-index: 2;
    }

    .disponible {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    .agotado {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    /* 5. Tipografía del Título */
    .titulo-libro {
        font-weight: 800;
        color: #2c3e50;
        font-size: 1rem;
        line-height: 1.3;
        /* Cortar texto con puntos suspensivos si es muy largo */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="catalogo-container mt-8">

    <div class="d-flex flex-column align-center mb-8">
        <MudText Typo="Typo.h3" Style="font-weight:900; color:#2c3e50; letter-spacing:-1px;">
            Catálogo Virtual
        </MudText>
        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
            Explora nuestra colección
        </MudText>
    </div>

    <div class="search-bar-glass">
        <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Medium" Color="Color.Primary" />

        <input type="text"
               @bind="textoBusqueda"
               @bind:event="oninput"
               placeholder="Busca por título, autor o 
..."
               style="border:none; outline:none; flex-grow:1; font-size:1.1rem; background:transparent; color:#333;" />

        @if (!string.IsNullOrEmpty(textoBusqueda))
        {
            <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="@(() => textoBusqueda = "")" />
        }
    </div>

    @if (LibrosFiltrados.Any())
    {
        <MudGrid Spacing="4">
            @foreach (var libro in LibrosFiltrados)
            {
                <MudItem xs="6" sm="4" md="3" lg="2">
                    <MudCard Class="libro-card" Elevation="0" OnClick="@(() => VerDetalles(libro))">

                        <div class="@(libro.Stock > 0 ? "badge-stock disponible" : "badge-stock agotado")">
                            @(libro.Stock > 0 ? "Disponible" : "Agotado")
                        </div>

                        <MudCardMedia Image="@(libro.ImagenUrl ?? "https://via.placeholder.com/300x450?text=Sin+Portada")" Height="260" />

                        <MudCardContent Class="pt-3 pb-3 px-3">
                            @if (libro.Categorias.Any())
                            {
                                <MudText Typo="Typo.caption" Color="Color.Primary" Style="font-weight:bold; text-transform:uppercase;">
                                    @libro.Categorias.First().NombreCategoria
                                </MudText>
                            }

                            <MudText Class="titulo-libro mt-1">@libro.Titulo</MudText>

                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1 d-block">
                                @(libro.Autores.Any() ? libro.Autores.First().Nombres : "Desconocido")
                            </MudText>
                        </MudCardContent>

                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <div class="d-flex flex-column align-center justify-center mt-12 opacity-50">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Style="font-size: 5rem; color: var(--gris);" />
            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">No encontramos libros con ese nombre.</MudText>
        </div>
    }

</MudContainer>

@code {
    private string textoBusqueda = "";
    private List<Libro> ListaLibros = new List<Libro>();

    // Filtro rápido en memoria
    private IEnumerable<Libro> LibrosFiltrados =>
        string.IsNullOrWhiteSpace(textoBusqueda)
        ? ListaLibros
        : ListaLibros.Where(l =>
            l.Titulo.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) ||
            (l.ISBN != null && l.ISBN.Contains(textoBusqueda)) ||
            l.Autores.Any(a => (a.Nombres + " " + a.Apellidos).Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase))
          );

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Carga Optimizado: Incluimos Autores y Categorias para mostrar en la tarjeta
            ListaLibros = await Contexto.Libros
                                        .Include(l => l.Autores)
                                        .Include(l => l.Categorias)
                                        .OrderByDescending(l => l.LibroID)
                                        .ToListAsync();
        }
        catch (Exception ex)
        {
            // Manejar error si la BD falla
        }
    }

    private void VerDetalles(Libro libro)
    {
        // Aquí llamas al Dialogo de Detalles que te pasé antes
        // Si aún no lo creas, este botón no hará nada visualmente por ahora.
        var parametros = new DialogParameters { ["LibroSeleccionado"] = libro };
        var opciones = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseButton = true, NoHeader = true };
        DialogService.Show<DetalleLibroDialog>("", parametros, opciones);
    }
}